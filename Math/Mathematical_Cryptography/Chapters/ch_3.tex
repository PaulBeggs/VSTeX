\section{Euler's Totient Theorem}

Remember \hyperlink{thm:Fermat's Little Theorem}{FLT} and \hyperlink{Discrete Logarithm Problem}{DLP}? Can we use FLT for non-prime moduli? No, FLT is only true for prime moduli: \(2^5 \ (\text{mod 6}) = 32 \). Thus, we need to look to other ways of solving this problem for non-primes.

\begin{theorem}
    {Euler's Totient Theorem for phi}Let \(N\) be a positive integer and let \(a\) be an integer such that \(\gcd(a, N) = 1\). Then, \[
        a^{\varphi(N)} \equiv 1 \ (\text{mod }{n}).
    \] where \(\varphi(N) = \#\{0 \leq x < N \mid \gcd(x,N) = 1\}\)
\end{theorem}

\begin{corollary}
    {1: Euler's Totient Theorem for \textit{phi}}If \(N\) is prime, \(a^{\varphi(N)} \equiv 1 \ (\text{mod } N)\). For \(\varphi(N)\), we can express it as \(N-1\) from \hyperlink{thm:Fermat's Little Theorem}{FLT}.
\end{corollary}

\cpf{
    If \(N\) is prime, then \(\gcd(a,N) = 1\). Thus, for all \(a\), such that \(0 < a < N\), \(\gcd(a,N) = 1\). Thus, \(\varphi(N) = N - 1\).
}

\begin{corollary}
    {2: Euler's Totient Theorem for \textit{phi}}If \(p,q\) are distinct primes, then \[
        a^{(p-1)(q-1)} \equiv 1 \ (\text{mod } pq) \quad \text{for all } a  \text{ such that } \gcd(a, pq) = 1.
    \] From this, we can state that \(N = pq\).
\end{corollary}

\cpf{
    For this proof, we would show that \(\varphi(pq) = \varphi(q) \cdot \varphi(p) = (p - 1)(q - 1)\).
}

\begin{example}
    {ETT for \textit{phi}}Find \(a^x \ (\text{mod } 15)\).
\end{example}

\lesol{
    \(15 = 3 \cdot 5\) (relatively prime); \(\varphi(15) = 2 \cdot 4 = 8\). Thus, \(a^8 \equiv 1 \ (\text{mod } 15)\).
}


\begin{theorem}
    {Euler's Totient Theorem for pq}Let \(p\) and \(q\) be distinct primes and let \[
        g = \gcd(p-1, q-1).
    \]Then, \[
        a^{(p-1)(q-1)/g} \equiv 1 \ (\text{mod } pq) \quad \text{for all } a  \text{ such that } \gcd(a, pq) = 1.
    \] In particular, if \(p\) and \(q\) are distinct primes, then \[
        a^{(p-1)(q-1)} \equiv 1 \ (\text{mod } pq) \quad \text{for all } a  \text{ such that } \gcd(a, pq) = 1.
    \]
\end{theorem}

Recall that for Diffie Hellman Elgamal we need to find \(a^x \ (\text{mod } p)\). Now, for RSA, we will be solving \(x^e \ (\text{mod } N)\) where \(N = pq\).

\wrpprop{3.2}{Let \(p\) be prime and let \(e\) be defined as \(\{e \in \Z \geq 1 \ \mid \ \gcd(e,p-q) = 1\}\). (Note this means that \(e^{-1} \text{mod } p - 1\) exists) Then, call \(d = e^{-1}\) i.e, \(d \equiv e^{-1} \ (\text{mod } p-1)\). Then, \(x^e \equiv c \ (\text{mod } p)\) has the unique solution \(x = c^d \ (\text{mod } p)\).}

\begin{example}
    {RSA 1}Find \(x\): \(x^3 \equiv 2 \ (\text{mod } 17)\).
\end{example}

\lesol{
    \begin{enumerate}
        \item Check with \(\gcd(3, 17-1) = \gcd(3,16)\) and 17 is a prime number. Thus, we can use \hyperlink{3.2}{Proposition 3.2}.
        \item Let \(d \cdot 3 \equiv 1 \ (\text{mod } 16) \equiv d \equiv 3^{-1} \ (\text{mod } 16) \equiv 11\) (Found with \hyperlink{thm:Extended Euclidean Algorithm}{EEA})
        \item Then, \(x^3 \equiv 2 \ (\text{mod } 17) \Rightarrow x \equiv 2^{11} \ (\text{mod } 17) \equiv 8\).
        \item To check: \(8^3 = 512 \ (\text{mod } 17) = 2\) \cmark
    \end{enumerate}
}

\wrpprop{3.5}{Let \(p \ne q\) be primes, and let \(e\) be defined as \(\{e \in \Z \geq 1 \ \mid \ \gcd(e,p-q) = 1\}\) Thus, there exists a \(d = e^{-1}\ (\text{mod } (p - 1)(q - 1))\). Then, \(x^e \equiv c \ (\text{mod } pq)\) has the unique solution \(x \equiv c^d \ (\text{mod } pq)\).}

\begin{example}
    {RSA 2}Solve \(x^{169} \equiv 1000 \ (\text{mod } 6887)\)
\end{example}

\lesol{
    \begin{enumerate}
        \item Check \(\gcd(169, (70)(96)) = \gcd(169, 6720) = 1\) where 70 and 96 are from the prime factorization of \(6887\) such that \((71 - 1)(97 - 1)\) are from \((p - 1)(q - 1)\).
        \item Solve for \(d\) such that \(d169 \equiv 1 \pmod{6720}\). Using \hyperlink{thm:Extended Euclidean Algorithm}{EEA}, we find that \(d \equiv -1511 \ (\text{mod} 6720) \equiv 5209\).
        \item Solve \(x \equiv 1000^{5209} \ (\text{mod } 6887) = 4055\)
    \end{enumerate}
}

\section{RSA Cryptosystem}

\hypertarget{sec:RSA Algorithm}{}

\subsection{RSA Algorithm}

Remember, multiplying is easy; we have tools to compute large numbers. However, factoring is hard. The RSA Cryptosystem is based on the difficulty of factoring large numbers. Thus, the RSA Cryptosystem is based on the following steps:
\begin{enumerate}
    \item Alice chooses two distinct primes \(p\) and \(q\) (private key).
    \item With integer \(e\) such that \(\gcd(e, (p-1)(q-1)) = 1\).
    \item Alice computes \(N = pq\) and \(d = e^{-1} \ (\text{mod } (p-1)(q-1))\).
    \item For Bob to send ``\(m\)'' to Alice, he computes \(c = m^e \ (\text{mod } N)\).
    \item Fro Alice to decrypt, she computes \(m' = c^d \ (\text{mod } N)\).
\end{enumerate}
\pfs

We claim that \(m' = m\). \\

\noindent \textit{Proof.} \begin{align*}
    d  & \equiv e^{-1}\pmod{(p-1)(q-1)}                             \\
    de & \equiv 1                       & \pmod{(p-1)(q-1)}         \\
    de & = 1 + k(p-1)(q-1)              & \text{for some } k \in \Z
\end{align*} Now that we know \(de\), we can compute \(m'\):

\begin{align*}
    m' & = c^d \pmod{N}                                  \\
       & = m^{ed} \pmod{N}                               \\
       & = m^{1 + k(p-1)(q-1)} \pmod{N}                  \\
       & = m \cdot m^{k(p-1)(q-1)} \pmod{N}              \\
       & = m \cdot (m^{(p-1)(q-1)})^k \pmod{N} \tag{3.1} \\
       & = m \cdot 1^k \pmod{N}                          \\
       & = m \pmod{N}.
\end{align*} Note for (3.1), we got 1 because we substituted for \(\varphi\). Hence, \begin{align*}
    m (m^{(p-1)(q-1)}) \pmod{N} & \equiv m (m^{\varphi(pq)} \pmod{N}) \\
                                & \equiv m \cdot 1 \pmod{N}.
\end{align*} \qed

Remember from Chapter 1, for a Cryptosystem to be a \hyperlink{Successful Ciphers}{successful cipher}, it must satisfy the following properties:

\begin{enumerate}
    \item \textbf{Encryption:} Must be easy to encrypt: \(c \equiv m^e \pmod{N}\).
    \item \textbf{Decryption:} Must be hard to decrypt:
          \begin{itemize}
              \item Need to find \(d \equiv e^{-1}\pmod{(p-1)(q-1)}\) which requires knowing \(p\) and \(q\) separately. Remember that factoring is hard.
          \end{itemize}
\end{enumerate}

\begin{example}
    {RSA 3}Let \(N = (47)(43) = 2021\) with private key \(47,43\) and \(e = 11\) (Note this means that \(e \ne 2 \cdot 23, \ 6 \cdot 7\), and so on). \begin{enumerate}[label=(\alph*)]
        \item Calculate Bob's public key.
        \item Encrypt the message \(m = 1050\) that Bob sends to Alice.
        \item Decrypt the message.
    \end{enumerate}
\end{example}

\lesol{
    \begin{enumerate}[label=(\alph*)]
        \item Calculate \(c\): \(c = 1050^{11} \pmod{2021} = 435\).
        \item Alice first finds \(d\): \(d \equiv 11^{-1} \pmod{(47 -1) (43 - 1)} \equiv 11^{-1} \pmod{1932}\). Using \hyperlink{thm:Extended Euclidean Algorithm}{EEA}, we find that \(d \equiv 527\).
        \item Then, \(m' = 435^{527} \pmod{2021} = 1050\).
    \end{enumerate}
}

\begin{center}
    \textbf{Remarks}:
\end{center}
\begin{itemize}
    \item We often choose small \(e\) to make the encryption process faster.
    \item Most agree that a smaller \(e\) is just as secure. The normal choice for \(e\) is 65537.
    \item What is the smallest possible \(e\) for a semiprime \(pq\)? \(e = 3\)
    \item This cryptosystem may be insecure if \(d < N^{1/4}\).
\end{itemize}

\section{Attacks on RSA}

\subsubsection{Brute Force Attack}

This involves factoring \(N = pq\). We only consider numbers below \(\sqrt{N}\).

\hypertarget{sec:Ciphertext Attack}{}

\subsection{Chosen Ciphertext Attack}

If Eve can find \((p-1)(q-1)\), then \(p\) and \(q\) are easy.  \\

\noindent \textit{Proof.} \begin{align*}
    (p-1)(q-1) & = pq - p - q + 1   \\
               & = pq - (p +q) + 1.
\end{align*} Thus, Eve just needs to solve the quadratic equation \((x-p)(x-q) = x^2 - (p+q)x + pq = 0\). \qed

\begin{example}
    {CCA}Factor \(N = 2701\) such that \((p-1)(q - 1) = 2592\).
\end{example}

\lesol{
    Find \begin{align*}
        (p-1)(q-1) & = pq - (p + q) + 1   \\
        2592       & = 2701 - (p + q) + 1 \\
        110        & = p + q.
    \end{align*}
    Then, solve the quadratic equation \(x^2 - 110x + 2701 = 0\) to find \(p\) and \(q\). Thus, \(x = 37, 73\).
}

\subsection{Timing Attacks (Ex. of Side Channel Attack)}

This attack is based on the time it takes to decrypt a message. More specifically, it monitors how long it takes a computation to complete. Then, it derives the relative sizes of \(p\) and \(q\).

\section{Primality Testing}

The only primality tests that we know so far is the brute force method. In other words, we brute force finding prime numbers. We do this by dividing \(N\) by primes. If no numbers \hyperlink{Divides}{divide} \(N\), then \(N\) is prime. This test is not efficient for large numbers.

Thus, consider a new test that utilizes \hyperlink{thm:Fermat's Little Theorem}{FLT}.

\begin{theorem}
    {Fermat's Little Theorem, Version 2}If \(p\) is prime, then \(a^P \equiv a \pmod{p}\). Consider the contrapositive to this statement: if \(a^P \not\equiv 1 \pmod{p}\) for some \(a\), then \(P\) is \textit{not} prime.
\end{theorem}

\begin{example}
    {FLT}Let \(N = 21\). Is \(N\) prime?
\end{example}

\lesol{
    Pick \(a = 3\). Check \(3^{21} \stackrel{?}{\equiv} 3 \pmod{21}\). No, \(3^{21} \equiv 6 \pmod{21}\). Hence, 21 is not prime.
}

\wrpdef{Fermat Witness}{We call \(a\) a \textit{witness} to the fact that \(N\) is composite if \(a^N \not\equiv a \pmod{N}\).}

\wrpdef{Fermat Liar}{A \textit{Fermat liar} is a number \(a\) such that, even though \(N\) is composite, it satisfies \(a^{-1} \equiv 1 \pmod{n}\). This gives a false indication that \(N\) is prime. Simply put, \(a\) ``lies'' by making \(N\) appear prime when it is not.}

However, there are some numbers will force all \(a\)'s to be fermat liars. These are called \textit{Carmichael Numbers}.

\wrpdef{Carmichael Numbers}{A composite number \(N\) is a \textit{Carmichael Number} if \(a^N \equiv a \pmod{N}\) for all \(a\) such that \(\gcd(a,N) = 1\).}
\newpage
\begin{example}
    {Carmichael Numbers}Solve \(37^{561} \equiv \pmod{561}\). What can you conclude about 561? Is it prime?
\end{example}

\lesol{
    \begin{enumerate}
        \item Check if 561 is prime. Pick \(a = 37\). Check \(37^{561} \stackrel{?}{\equiv} 37 \pmod{561}\). Yes, \(37^{561} \equiv 37 \pmod{561}\). Thus, 561 is prime. Right?
        \item If we check for all \(a < 561\), we will see that 561 has no \hyperlink{Fernat Witness}{Fermat witnesses}. However, we know that 561 is composite, so that means 561 is a Carmichael Number.
    \end{enumerate}
}
\hypertarget{sec:Miller-Rabin}{}
\subsection{Miller-Rabin Primality Test}

\wrpprop{3.17}{Let \(p\) be an odd prime, and write \(p - 1 = 2^kq\) with \(q\) being odd. Then, let \(a\) be any number not divisible by \(p\). Then, one of the following must hold: \begin{enumerate}[label=(\roman*)]
        \item \(a^q \equiv 1 \pmod{p}\).
        \item One of \(a^q,a^{2q},a^{4q},\dots,a^{2^{k-1}q}\) is congruent to \(-1\) modulo \(p\). 
    \end{enumerate}}

\begin{center}
    \textbf{Miller-Rabin Algorithm }    
\end{center}

\begin{enumerate}
    \item Choose an odd integer \(n > 2\) to test for primality.
    \item Write \(n - 1 = 2^k \cdot q\) where \(q\) is odd and \(k \geq 1\). 
    \item Pick a random integer \(a\) such that \(2 \leq a \leq n - 2\).
    \item compute \(x = a^q \pmod{n}\).
    \begin{itemize}
        \item If \(x = 1\) or \(x = n - 1\), \textbf{continue to the next base because this indicates that the number is probably prime.}
    \end{itemize}
    \item Square \(x\), up to \(k - 1\) times:
    \begin{itemize}
        \item If \(x = n - 1\) at any step, \textbf{continue to the next base for the same reason.}
        \item If \(x \ne n - 1\) for all squarings, \textbf{\(n\) is composite.}
        
        For example, if we have a number and we keep squaring \(x\) up to \(k - 1\), and we never encounter a \(n - 1\), but we encounter other numbers like 1 or anything else, then the number is composite. Remember: ONLY composite if there was NO record of a \(n - 1\) for a given base \(x\).
    \end{itemize}
    \item Repeat the test with different random bases \(a\).
\end{enumerate}

\begin{lstlisting}[language=Python, numbers=left]
    # Input: N is the integer to be factored.
    def pollard_s_p(N):
        # Set a to a to a convenient value.
        a = 2
        j = 0
        # Set an arbitrary bound for j.
        while j < 100:
            a = pow(a, j, N)
            d = math.gcd(a - 1, N)
            if 1 < d < N:
                return d
            j += 1
        # The number is either prime, or j's bound was not large enough.
        return None
\end{lstlisting}

\wrpdef{Miller-Rabin Witness}{Let \(N\) be an odd number. Write \(N - 1 = 2^kq\) with \(q\) odd. If \(a\) is an integer that satisfies \(\gcd(a,N) = 1\), then \(a\) is a \textit{Miller-Rabin Witness} for \(N\) if both of the following hold: \begin{enumerate}[label=(\roman*)]
        \item \(a^q \not\equiv 1 \pmod{N}\).
        \item \(a^{2^iq} \not\equiv -1 \pmod{N}\) for all \(i\) such that \(0 \leq i \leq k-1\).
    \end{enumerate}}

\begin{example}
    {Miller-Rabin Test 1}Let \(N = 561\). Is \(N\) prime?
\end{example}

\lesol{
    \begin{enumerate}
        \item Write \(N - 1 = 2^4 \cdot 35\).
        \item Pick \(a = 7\). Start by solving \(7^{35} \pmod{561} \equiv 241\). If it was congruent to 1 or \(-1\), then \(N\) is a possible prime.
        \item If the number is neither congruent to 1 or \(-1\), keep squaring and checking up to \(k - 1\) times.
              \begin{itemize}
                  \item Like this: \((7^{36})^2 \pmod{561} \equiv 298\). If this number is congruent to 1, then we are done and the number is composite.
              \end{itemize}
        \item If it is congruent to \(-1\), then we choose another \(a\), and note this is a possible prime. If it is not congruent to either \(-1\) or 1, then keep squaring up to \(k - 1\) times.
        \item Thus, \((7^{36})^4 \pmod{561} \equiv 166\), \((7^{36})^8 \pmod{561} \equiv 67\), and \((7^{36})^{16} \pmod{561} \equiv 1\), so 561 is composite and 7 is a \hyperlink{Miller-Rabin Witness}{M-R witness} because we found a 1 before we found a \(-1\) in the sequence.
    \end{enumerate}
}

\begin{example}
    {Miller-Rabin Test 2}Let \(N = 563\). Let \(a = 7\). Is \(N\) prime?
\end{example}

\lesol{
    \(N - 1 = 562 = 2(281)\). Start by solving \(7^{281} \pmod{563} \equiv 1\). Thus, 563 is a possible prime. Choose \(a = 8\). Then, \(8^{281} \pmod{563} \equiv -1\), so \(N\) is a possible prime.
}

\begin{example}
    {Miller-Rabin Test 3}Let \(N = 31001\). Determine if \(N\) is prime. 
\end{example}

\lesol{
    Start by finding \(p - 1 = 31000 = 2^3 \cdot 3875\). Then, use the fast powering algorithm to find \(b_0 = 2^{3875} \pmod{31001} \equiv 5799\) for \(b_1\). Since \(b_1\) is not 1 or \(-1\), we will try the other bases up to \(k - 1 = 3 - 1 = 2\). Thus, we use the fast powering algorithm to solve for subsequent \(b\)'s: 
    \[\begin{array}{lccccr}
        b_0^{3875} &=& 2^{3875} &\equiv& 5799 \pmod{31001} &= b_1 \\
        b^2_1 &=& 5799^2 &\equiv& 13026 \pmod{31001} &= b_2 \\
        b^2_2 &=& 13026^2 &\equiv& 8203 \pmod{31001} &= b_3
    \end{array}\] 
    Since no \(n - 1\) appeared in these steps, and there was not a 1 that appeared before a \(-1\), then this number is composite.
}

\begin{note}
    \textbf{Note:} Let \(N\) be an odd positive integer. Then, \(\geq 75\%\) of \(a\)'s are between \(1\) and \(n - 1\) are \hyperlink{Miller-Rabin Witness}{Miller-Rabin Witnesses} for \(N\).
\end{note}

\section{Pollard's Factorization Algorithm}

For \(N = pq\) semiprime, this algorithm is efficient when \(p -1\) only has small prime factors.

This algorithm is based on the following steps:

\begin{itemize}
    \item \textbf{Step 1:} \textit{Choose a smooth bound B:} The smooth bound is a small number such that the prime factors of \(p - 1\) (where \(p\) is a prime factor of \(n\)) are less than or equal to \(B\).
    \item \textbf{Step 2:} \textit{Compute the least common multiple of all integers up to \(B\), call this number \(k\).}
    \item \textbf{Step 3:} \textit{Pick a random base a:} Choose an integer \(a\) such that \(2 \leq a \leq n - 2\).
    \item \textbf{Step 4:} \textit{Compute \(a^{k} \pmod{n}\)}.
    \item \textbf{Step 5:} \textit{Find the GCD of \(a^k - 1\) and \(n\):} The greatest common divisor \(\gcd(a^k - 1, n)\) may give a non-trivial factor of \(n\).
    \item \textbf{Step 6:} If \(\gcd(a^k - 1,n) = n\), try a different \(a\) or increase \(B\).
\end{itemize}

\begin{example}
    {Pollard's Factorization Algorithm}Factor 540143 with \(a = 2\).
\end{example}

\lesol{ \vspace{0.5cm} \newline
    \begin{tabular}{l|l|c|r}
        \(B\) & \(\text{lcm}(k = 1,2\dots, 13)\)                                   & \(2^k - 1 \pmod{510143}\)             & \(\gcd(2^k - 1, 510143)\)      \\ \midrule
        5     & \(\text{lcm}(1,2,\underline{3},\underline{4},\underline{5}) = 60\) & \(2^{60 - 1 \pmod{540143}}\)          & \(\gcd(338353, 540143) = 1\)   \\ \midrule
        7     & \(\text{lcm}(1,2,\dots,7) = 420\)                                  & \(2^{420} - 1 \pmod{540143} = 42942\) & \(\boxed{421}\  \text{Stop!}\) \\  \bottomrule
    \end{tabular} \newline

    Thus, we found that 421 is a factor of 540143.
}

\section{Factorization via Difference of Squares}

We would only use this method if prime numbers, \(p\) and \(q\) are close to each other.

To Factor \(N\) we find a value \(k\) such that \(N + k^2 = m^2\) for some \(m \in \Z\). This is equal to \(N = m^2 - k^2 = (m+k)(m-k)\).

\begin{example}
    {Factorization 1} Factor 45.
\end{example}

\lesol{
    \begin{align*}
        45 + 1^2 & = 46 \ \text{\xmark} \\
        45 + 2^2 & = 49 \ \text{\cmark} \\
        45       & = 7^2 - 2^2          \\
        45       & = (7 + 2)(7 - 2)     \\
        45       & = (9)(5)
    \end{align*}
}


\begin{example}
    {Factorization 2} Factor \(N = 25217\) by looking for an integer \(b\) making \(N + b^2\) a perfect square.
\end{example}

\lesol{
    We factor \( N = 25217 \) by looking for an integer \( b \) making \( N + b^2 \)
    a perfect square:


    \begin{align*}
        25217 + 1^2 & = 25218         & \text{not a square},            \\
        25217 + 2^2 & = 25221         & \text{not a square},            \\
        25217 + 3^2 & = 25226         & \text{not a square},            \\
        25217 + 4^2 & = 25233         & \text{not a square},            \\
        25217 + 5^2 & = 25242         & \text{not a square},            \\
        25217 + 6^2 & = 25253         & \text{not a square},            \\
        25217 + 7^2 & = 25266         & \text{not a square},            \\
        25217 + 8^2 & = 25281 = 159^2 & \text{Eureka! \textbf{square}.}
    \end{align*}


    Then we compute

    \[
        25217 = 159^2 - 8^2 = (159 + 8)(159 - 8) = 167 \cdot 151.
    \]

}

